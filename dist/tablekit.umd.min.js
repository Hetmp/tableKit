!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("datatables.net"),require("jquery.validation"),require("jquery")):"function"==typeof define&&define.amd?define(["datatables.net","jquery.validation","jquery"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).TableKit=e()}(this,function(){"use strict";let t={};function e(t,e,n,r){return new(n||(n=Promise))(function(i,o){function s(t){try{l(r.next(t))}catch(t){o(t)}}function a(t){try{l(r.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(s,a)}l((r=r.apply(t,e||[])).next())})}"function"==typeof SuppressedError&&SuppressedError;class n{constructor(t){this.options=t}Save(t){return e(this,void 0,void 0,function*(){var e,n,r,i;let o;const s=t[this.options.id||"id"];if("string"==typeof(null===(e=this.options.ajax)||void 0===e?void 0:e.create)&&(this.options.ajax.create={url:this.options.ajax.create}),"string"==typeof(null===(n=this.options.ajax)||void 0===n?void 0:n.update)&&(this.options.ajax.update={url:this.options.ajax.update}),o=s&&0!==s&&"0"!==s?null===(i=this.options.ajax)||void 0===i?void 0:i.update:null===(r=this.options.ajax)||void 0===r?void 0:r.create,!o)return{success:!1,status:0,errors:[{key:"config error",errors:["No matching ajax operation (create/update) found"]}],rowData:t};try{const e=yield fetch(o.url,{method:o.method||"POST",headers:Object.assign({"Content-Type":"application/json"},o.headers||{}),body:JSON.stringify(t)});if(!e.ok)return{success:!1,status:e.status,errors:[{key:"server error",errors:[e.statusText]}],rowData:t};return yield e.json()}catch(e){return{success:!1,status:0,errors:e,rowData:t}}})}}class r{constructor(){this._form=$("<form>")}validateForm(){return this._form.validate().form()}validateSingleField(t){return this._form.validate().element(t)}parse(){$.validator.unobtrusive.parse(this._form.get(0))}formWrapper(t){return this._form=this._hasAnyForm(t),this._wrapInForm(t,this._form)}_hasAnyForm(t){return $(t).closest("form")}_wrapInForm(t,e){return this._form=e.length>0&&e||$("<form>"),this._form.append(t),this._form}}class i{constructor(t,e){this.selector=t,this.config=e,this.colConfig=e.columns,this.$table=$(t),this.clickHandler=this.click.bind(this),this.init()}init(){this.table=$(this.selector).DataTable(),!1!==this.config.editable&&this.$table.on("click","tbody td",t=>{this.clickHandler(t)})}click(t){const e=this.table.cell(t.currentTarget),n=this.table.row($(t.currentTarget).closest("tr")),r=e.index().column,i=this.table.settings()[0].aoColumns[r].mData,o=this.colConfig.find(t=>t.name.toLowerCase()===i.toLowerCase());o&&o.editable&&this.makeEditable(n,e,o)}makeEditable(t,e,i){const o=e.data(),s=$(e.node());if(s.find("input").length>0)return;const a=i.template&&this.getTemplate(i.template)||this.createInputElement(o),l=new r,c=l.formWrapper(a);c.on("submit",t=>(t.preventDefault(),!1)),"unobtrusive"===this.config.validation&&l.parse(),s.html(""),s.append(c);const u=s.find("input");this.setTemplateValue(s.get(0),o),u.trigger("focus"),u.on("focusout",()=>{s.html(u.val()||"")}),u.on("change",()=>{i.validate&&c.valid(),u.val()!==o&&$(e.node()).attr("data-dirty","true");const r=t.data();r[i.name]=u.val(),s.empty().append(function(){const t=document.createElement("div");return t.classList.add("tablekit-loading"),t.innerHTML="<span></span><span></span><span></span>",t}()),new n(this.config).Save(r).then(n=>{n.success?(t.data(n.data).draw(),$(e.node()).removeAttr("data-dirty"),$(e.node()).addClass("tablekit-saved")):(r[i.name]=o,t.data(r).draw(),this._showError(s.get(0),n.errors||[],o))})})}getTemplate(t){var e;if("string"==typeof t&&t.startsWith("#")){const n=null===(e=document.getElementById(t.substring(1)))||void 0===e?void 0:e.innerHTML,r=document.createElement("div");return r.innerHTML=n||"",r}return t}setTemplateValue(t,e){const n=t.querySelector("input, select, textarea");return n&&(n.value=e),t}createInputElement(t){const e=document.createElement("input");return e.type="text",e.className="tablekit-input form-control",e.value=t,e.required=!0,e}_showError(t,e,n){t.dataset.oldValue=n,t.innerHTML='\n    <div class="tablekit-error" title="Click to see errors">!</div>\n  ';const r=t.querySelector(".tablekit-error");r&&r.addEventListener("click",()=>{this._showErrorPopup(e),t.textContent=n})}_showErrorPopup(t){var e;console.log(t);const n=t.map(t=>`\n        <div class="tablekit-error-block">\n          <strong>${t.key}</strong>\n          <ul>\n            ${t.errors.map(t=>`<li>${t}</li>`).join("")}\n          </ul>\n        </div>\n      `).join(""),r=document.createElement("div");r.className="tablekit-popup",r.innerHTML=`\n    <div class="tablekit-popup-content">\n      <h4>Validation Errors</h4>\n      <div>${n}</div>\n      <button id="popupClose">Close</button>\n    </div>\n  `,document.body.appendChild(r),null===(e=r.querySelector("#popupClose"))||void 0===e||e.addEventListener("click",()=>{r.remove()})}}class o{constructor(t,e){this.selector=t,this.config=e,this.init()}init(){"cell"===this.config.mode&&new i(this.selector,this.config)}}return o.setGlobalConfig=function(e){t=Object.assign(Object.assign({},t),e)},o.version="1.0.1",function(t){t.fn.tablekit=function(e){return this.each(function(){const n=new o(`#${t(this).attr("id")}`,e);t(this).data("tablekit",n)}),this}}(jQuery),o});
//# sourceMappingURL=tablekit.umd.min.js.map
